<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Urban Heat vs Tree Cover - Greater Melbourne (DV2)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Vega, Vega-Lite, and vega-embed from jsDelivr -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        }

        header {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 20px;
        }

        .row {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        #map-1,
        #map-2 {
            flex: 1 1 520px;
            /* grow to fill, base width ~520px */
            min-width: 420px;
            /* stack when narrower than this */
        }
    </style>
</head>

<body>
    <header>
        <h1>Urban Heat vs Tree Cover - Greater Melbourne</h1>
    </header>

    <div class="wrap">
        <div class="row">
            <div id="map-1"></div>
            <div id="map-2"></div>
        </div>
    </div>

    <script>
        const topo = {
            url: "data/processed/melb_sa2_simplified.topojson",
            format: { type: "topojson", feature: "melb_sa2" }
        };

        // Tell Vega-Lite to parse the CSV fields as NUMBERS (prevents NaN)
        const csvFrom = {
            data: {
                url: "data/processed/melb_sa2_stats.csv",
                format: { type: "csv", parse: { uhi_mean: "number", tree_sum: "number", tree_count: "number" } }
            },
            key: "SA2_CODE21",
            fields: ["uhi_mean", "SA2_NAME21", "tree_sum", "tree_count"]
        };

        const baseGeom = {
            width: 520, height: 560,
            projection: { type: "mercator" },
            data: topo,
            transform: [
                { lookup: "properties.SA2_CODE21", from: csvFrom },
                { calculate: "datum.tree_count > 0 ? (datum.tree_sum/datum.tree_count)*100 : null", as: "tree_pct" }
            ],
            mark: { type: "geoshape" },
            encoding: {
                stroke: { value: "#ffffff" },
                strokeWidth: { value: 0.5 }
            },
            config: { view: { stroke: null } }
        };

        // LEFT: UHI
        const specUHI = {
            title: "Mean UHI (2018-19, °C)",
            "offset": 20,
            $schema: "https://vega.github.io/schema/vega-lite/v5.json",
            ...baseGeom,
            encoding: {
                ...baseGeom.encoding,
                color: { field: "uhi_mean", type: "quantitative", title: "Mean UHI (2018-19, °C)", scale: { scheme: "reds" } },
                tooltip: [
                    { field: "SA2_NAME21", type: "nominal", title: "SA2" },
                    { field: "properties.SA2_CODE21", type: "nominal", title: "SA2 code" },
                    { field: "uhi_mean", type: "quantitative", title: "UHI mean (°C)", format: ".2f" },
                    { field: "tree_pct", type: "quantitative", title: "Tree cover (%)", format: ".1f" }
                ]
            }
        };

        // RIGHT: Tree cover %
        const specTree = {
            title: "Tree cover (%)",
            "offset": 20,
            $schema: "https://vega.github.io/schema/vega-lite/v5.json",
            ...baseGeom,
            encoding: {
                ...baseGeom.encoding,
                color: { field: "tree_pct", type: "quantitative", title: "Tree cover (%)", scale: { scheme: "greens" } },
                tooltip: [
                    { field: "SA2_NAME21", type: "nominal", title: "SA2" },
                    { field: "properties.SA2_CODE21", type: "nominal", title: "SA2 code" },
                    { field: "tree_pct", type: "quantitative", title: "Tree cover (%)", format: ".1f" },
                    { field: "uhi_mean", type: "quantitative", title: "UHI mean (°C)", format: ".2f" }
                ]
            }
        };

        vegaEmbed("#map-1", specUHI, { actions: false });
        vegaEmbed("#map-2", specTree, { actions: false });
    </script>

    <script>
        // SCATTERPLOT: Tree cover (%) vs. Mean UHI (°C) by SA2
        const scatterSpec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "width": 1100,
            "height": 380,
            "data": { "url": "data/processed/melb_sa2_stats.csv" },
            "transform": [
                { "calculate": "datum.tree_count > 0 ? (datum.tree_sum/datum.tree_count)*100 : null", "as": "tree_pct" },
                { "filter": "isValid(datum.tree_pct) && isValid(datum.uhi_mean)" }
            ],
            "layer": [
                {
                    "mark": { "type": "point", "filled": true, "opacity": 0.7, "size": 45 },
                    "encoding": {
                        "x": { "field": "tree_pct", "type": "quantitative", "title": "Tree cover (%)" },
                        "y": { "field": "uhi_mean", "type": "quantitative", "title": "Mean UHI (2018-19, °C)" },
                        "tooltip": [
                            { "field": "SA2_NAME21", "type": "nominal", "title": "SA2" },
                            { "field": "SA2_CODE21", "type": "nominal", "title": "SA2 code" },
                            { "field": "tree_pct", "type": "quantitative", "title": "Tree cover (%)", "format": ".1f" },
                            { "field": "uhi_mean", "type": "quantitative", "title": "UHI mean (°C)", "format": ".2f" }
                        ],
                        "color": {
                            "field": "tree_pct",
                            "type": "quantitative",
                            "scale": { "scheme": "greens" },
                            "title": "Tree cover (%)"
                        }
                    }
                },
                {
                    // add a regression (linear fit) line
                    "transform": [{ "regression": "uhi_mean", "on": "tree_pct" }],
                    "mark": { "type": "line", "color": "#333", "strokeWidth": 2 },
                    "encoding": {
                        "x": { "field": "tree_pct", "type": "quantitative" },
                        "y": { "field": "uhi_mean", "type": "quantitative" }
                    }
                }
            ],
            "config": {
                "axis": { "labelFontSize": 12, "titleFontSize": 12 },
                "view": { "stroke": null }
            }
        };

        vegaEmbed("#scatter", scatterSpec, { actions: false });
    </script>


    <section class="wrap">
        <h2 style="margin:24px 0 8px">How tree cover relates to urban heat (SA2s)</h2>
        <p style="margin:0 0 12px;color:#666">Each dot is an SA2. Line shows linear fit.</p>
        <div id="scatter" style="max-width:1200px"></div>
    </section>

</body>

</html>
